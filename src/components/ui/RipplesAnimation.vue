<template>
    <div class="testing">
        <div class="test test1"></div>
        <div class="test test2"></div>
        <div class="test test3"></div>
    </div>

    <div class="box">
        <svg class="circle c1" width="225" height="254" viewBox="0 0 225 254" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g filter="url(#filter0_ddf)">
            <circle cx="112.692" cy="128.125" r="57.7504" transform="rotate(-38.4475 112.692 128.125)" stroke="#288dc5" stroke-width="8" />
            </g>
            <defs>
            <filter id="filter0_ddf" x="0.934082" y="0.367432" width="223.516" height="253.516" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                <feOffset dy="14" />
                <feGaussianBlur stdDeviation="12.5" />
                <feColorMatrix type="matrix" values="0 0 0 0 0.486275 0 0 0 0 0.458824 0 0 0 0 0.435294 0 0 0 0.45 0" />
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow" />
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                <feOffset dy="-16" />
                <feGaussianBlur stdDeviation="12.5" />
                <feColorMatrix type="matrix" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.8 0" />
                <feBlend mode="normal" in2="effect1_dropShadow" result="effect2_dropShadow" />
                <feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow" result="shape" />
                <feGaussianBlur stdDeviation="7.5" result="effect3_foregroundBlur" />
            </filter>
            </defs>
        </svg>

        <svg class="circle c2" width="225" height="254" viewBox="0 0 225 254" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g filter="url(#filter0_ddf)">
            <circle cx="112.692" cy="128.125" r="57.7504" transform="rotate(-38.4475 112.692 128.125)" stroke="#288dc5" stroke-width="8" />
            </g>
            <defs>
            <filter id="filter0_ddf" x="0.934082" y="0.367432" width="223.516" height="253.516" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                <feOffset dy="14" />
                <feGaussianBlur stdDeviation="12.5" />
                <feColorMatrix type="matrix" values="0 0 0 0 0.486275 0 0 0 0 0.458824 0 0 0 0 0.435294 0 0 0 0.45 0" />
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow" />
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                <feOffset dy="-16" />
                <feGaussianBlur stdDeviation="12.5" />
                <feColorMatrix type="matrix" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.8 0" />
                <feBlend mode="normal" in2="effect1_dropShadow" result="effect2_dropShadow" />
                <feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow" result="shape" />
                <feGaussianBlur stdDeviation="7.5" result="effect3_foregroundBlur" />
            </filter>
            </defs>
        </svg>

        <svg class="circle c3" width="225" height="254" viewBox="0 0 225 254" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g filter="url(#filter0_ddf)">
            <circle cx="112.692" cy="128.125" r="57.7504" transform="rotate(-38.4475 112.692 128.125)" stroke="#288dc5" stroke-width="8" />
            </g>
            <defs>
            <filter id="filter0_ddf" x="0.934082" y="0.367432" width="223.516" height="253.516" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                <feOffset dy="14" />
                <feGaussianBlur stdDeviation="12.5" />
                <feColorMatrix type="matrix" values="0 0 0 0 0.486275 0 0 0 0 0.458824 0 0 0 0 0.435294 0 0 0 0.45 0" />
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow" />
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" />
                <feOffset dy="-16" />
                <feGaussianBlur stdDeviation="12.5" />
                <feColorMatrix type="matrix" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.8 0" />
                <feBlend mode="normal" in2="effect1_dropShadow" result="effect2_dropShadow" />
                <feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow" result="shape" />
                <feGaussianBlur stdDeviation="7.5" result="effect3_foregroundBlur" />
            </filter>
            </defs>
        </svg>

    </div>
</template>

<style scoped>
    .testing,
.box {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.test,
.circle {
  position: absolute;
  top: 300px;
  left: 50%;
  transform: translate(-50%, -50%);
}

.test1,
.c1 {
  height: 200px;
  width: 200px;
  opacity: 0;
}

.test2,
.c2 {
  height: 400px;
  width: 400px;
  opacity: 1;
}

.test3,
.c3 {
  height: 600px;
  width: 600px;
  opacity: 0.5; 
}
</style>

<script setup>
import { gsap } from 'gsap';
import { ref, onMounted, watch, defineEmits } from 'vue';

let stopAnimation = ref(false);
let waves;
let wheelListener = null;
let darkBlue = false;
const emit = defineEmits();

const logScales = () => {
    const circles = document.querySelectorAll('.circle');
    circles.forEach((circle, index) => {

        const transform = window.getComputedStyle(circle).transform;

        if (transform !== 'none') {
            const matrix = transform.match(/matrix\((.+)\)/);
            if (matrix && matrix[1]) {
                const values = matrix[1].split(', ');
                const scaleX = parseFloat(values[0]);
                console.log(`Circle ${index + 1}: ScaleX = ${scaleX}`);
            }
        } else {
            console.log(`Circle ${index + 1}: No scale applied.`);
        }
    });
};

const getScales = () => {
    const circles = document.querySelectorAll('.circle');
    const scales = [];

    circles.forEach((circle, index) => {
        const transform = window.getComputedStyle(circle).transform;

        if (transform !== 'none') {
            const matrix = transform.match(/matrix\((.+)\)/);
            if (matrix && matrix[1]) {
                const values = matrix[1].split(', ');
                const scaleX = parseFloat(values[0]);
                scales.push(scaleX); 
            }
        } else {
            scales.push(null);
        }
    });

    return scales;
};


const addWindowListener = () => {
    document.body.style.overflow = 'hidden';
    if (wheelListener)
        window.removeEventListener('wheel', wheelListener);

    setTimeout(() => {
        wheelListener = (event) => {
            const circles = document.querySelectorAll('.circle');
            let delta = event.deltaY;
            const scaleFactor = delta > 0 ? 0.2 : -0.2;
            let scales = getScales();

            //Ripples is growing
            // play + scroll up --> GOING DARK BLUE + NO CIRCLE + NO TEXT
            if(!stopAnimation.value && delta > 0)
            {
                console.log("going dark blue");
                stopAnimation.value = true;
                gsap.to("#backgroundRipples", {
                    backgroundColor: "#0055b3",
                    duration: 0.5,
                    ease: "power1.inOut",
                    onComplete: () => {
                        gsap.to(".circle", {
                            opacity: 0,
                            duration: 0.4,
                            ease: "ease"
                        });
                    }
                });
                gsap.to("#textRipples", {
                    opacity: 0,
                    duration: 0.5,
                    ease: "power1.inOut",
                    onComplete: () => {
                        console.log("going swimming");
                    window.removeEventListener('wheel', wheelListener);
                    emit('updateSwimmer', true); 
                    }
                });
            }

            // play + scroll down --> GOING HOME
            if(!stopAnimation.value && delta <= 0)
            {
                console.log("au revoir windows listener");
                window.removeEventListener('wheel', wheelListener);
                emit('updateGoUp', true); 
            }

            // Stop + scroll down --> PLAY
            if(stopAnimation.value && delta <= 0 && scales[0] <= 1.7)
                stopAnimation.value = false;

            const textRipples = document.querySelector("#textRipples");
            const textOpacity = window.getComputedStyle(textRipples).opacity;

            //console.log(delta);
            // stop + dark blue + scroll down --> GOING BLUE ORIGINAL + ANIMATION
            if(stopAnimation.value && textOpacity == 0 && delta < 0)
            {
                // Going blue original
                console.log("going blue original");
                gsap.to("#backgroundRipples", {
                    backgroundColor: "#6ec3fe",
                    duration: 0.5,
                    ease: "power1.inOut",
                });
                // Title visible
                gsap.to("#textRipples", {
                    opacity: 1,
                    duration: 0.5,
                    ease: "power1.inOut",
                });

                // Circles visible
                gsap.to(".circle", {
                    opacity: 1,
                    duration: 0.2,
                    ease: "ease",
                });

                stopAnimation.value = false;
            }

            if(stopAnimation.value) {
                console.log("circles moving by wheel");
                gsap.to(circles, {
                    scale: `+=${scaleFactor}`,
                    duration: 0.05,
                    ease: 'none',
                });
            }
        }

        window.addEventListener('wheel', wheelListener);
    }, 500);
};

const startWavesAnimation = () => {
    waves = gsap.timeline({
        repeat: -1,
        defaults: {
            duration: 1.0,
            ease: 'none',
        },
    });

    waves
        .to('.c1, .test1', { scale: 2, opacity: 1 }, 0)
        .to('.c2, .test2', { scale: 1.5, opacity: 0.5 }, 0)
        .to('.c3, .test3', { scale: 1, opacity: 0 }, 0);
};


watch(stopAnimation, (newVal) => {
    if (newVal) {
        waves.pause();
    } else {
        waves.resume();
    }
});

onMounted(() => {
    startWavesAnimation();
});

defineExpose({
    addWindowListener,
});
</script>




