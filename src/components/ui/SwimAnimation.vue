<template>
        <div class="svg-container">
            <svg class="svg1" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 900" fill="none" preserveAspectRatio="none">
                <path class="line line3" d="M-10,348c15,17,24,43,68,47s97-43,183-12s165,73,283,49 s290-98,472-87c131.22,7.93,225.6,51.07,304,38"/>
                <path class="line line2" d="M-10,348c15,17,24,43,68,47s97-43,183-12s165,73,283,49 s290-98,472-87c131.22,7.93,225.6,51.07,304,38"/>
                <path class="line line1" d="M-10,348c15,17,24,43,68,47s97-43,183-12s165,73,283,49 s290-98,472-87c131.22,7.93,225.6,51.07,304,38"/>
            </svg>
            <svg class="svg2" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 900" fill="none" preserveAspectRatio="none">
                <path class="line line3" d="M-10,319c28-9,68.84,25.02,116,26c48,1,83.41-12.8,124-7 c42,6,84,45,161,59s144,12,263-36s234-86,371-62s216,52,279,62"/>
                <path class="line line2" d="M-10,319c28-9,68.84,25.02,116,26c48,1,83.41-12.8,124-7 c42,6,84,45,161,59s144,12,263-36s234-86,371-62s216,52,279,62"/>
                <path class="line line1" d="M-10,319c28-9,68.84,25.02,116,26c48,1,83.41-12.8,124-7 c42,6,84,45,161,59s144,12,263-36s234-86,371-62s216,52,279,62"/>
            </svg>
            <svg class="svg3" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 900" fill="none" preserveAspectRatio="none">
                <path class="line line3" d="M-10,296c27-13,59-22,107,0c71.61,32.82,113,14,175,22 s117,50,223,45s165-45,277-73s210-56,532,43"/>
                <path class="line line2" d="M-10,296c27-13,59-22,107,0c71.61,32.82,113,14,175,22 s117,50,223,45s165-45,277-73s210-56,532,43"/>
                <path class="line line1" d="M-10,296c27-13,59-22,107,0c71.61,32.82,113,14,175,22 s117,50,223,45s165-45,277-73s210-56,532,43"/>
            </svg>
            <svg class="svg4" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 900" fill="none" preserveAspectRatio="none">
                <path class="line line3" d="M-10,263c15-6,85-39,117-13c52.68,42.81,124,38,182,35 s123,63,275,32s235-75,349-72s242,13,391,64"/>
                <path class="line line2" d="M-10,263c15-6,85-39,117-13c52.68,42.81,124,38,182,35 s123,63,275,32s235-75,349-72s242,13,391,64"/>
                <path class="line line1" d="M-10,263c15-6,85-39,117-13c52.68,42.81,124,38,182,35 s123,63,275,32s235-75,349-72s242,13,391,64"/>
            </svg>
            <svg class="svg5" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 900" fill="none" preserveAspectRatio="none">   
                <path class="line line3" d="M-10,225c0,0,39-33,79-38s61,24,100,44s101-7,159,19 s81,48,221,37s245-55,311-68s160-16,240-1s137,39,208,55"/>
                <path class="line line2" d="M-10,225c0,0,39-33,79-38s61,24,100,44s101-7,159,19 s81,48,221,37s245-55,311-68s160-16,240-1s137,39,208,55"/>
                <path class="line line1" d="M-10,225c0,0,39-33,79-38s61,24,100,44s101-7,159,19 s81,48,221,37s245-55,311-68s160-16,240-1s137,39,208,55"/>
            </svg>
            <svg class="svg6" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 900" fill="none" preserveAspectRatio="none">    
                <path class="line line3" d="M-10,192c0,0,51-54,91-59s60,8,99,28s83,24,141,50 s152,48,292,37s203-51,269-64s142-15,222,0s136,37,207,53"/>
                <path class="line line2" d="M-10,192c0,0,51-54,91-59s60,8,99,28s83,24,141,50 s152,48,292,37s203-51,269-64s142-15,222,0s136,37,207,53"/>
                <path class="line line1" d="M-10,192c0,0,51-54,91-59s60,8,99,28s83,24,141,50 s152,48,292,37s203-51,269-64s142-15,222,0s136,37,207,53"/>
            </svg>
            <svg class="svg7" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 900" fill="none" preserveAspectRatio="none">    
                <path class="line line3" d="M-10,144c0,0,54-39,94-44s85,7,124,27s59,25,117,51 s153,52,293,41s188-53,254-66s148-13,228,2s181,38,211,38"/>
                <path class="line line2" d="M-10,144c0,0,54-39,94-44s85,7,124,27s59,25,117,51 s153,52,293,41s188-53,254-66s148-13,228,2s181,38,211,38"/>
                <path class="line line1" d="M-10,144c0,0,54-39,94-44s85,7,124,27s59,25,117,51 s153,52,293,41s188-53,254-66s148-13,228,2s181,38,211,38"/>
            </svg>
        </div>
        <img v-show="swimmer" id="swimAnimation" src="@/assets/images/nageurAvant.png" />
        <h1 id="swim1" class="title-swim text-6xl sm:text-[5rem] font-extrabold drop-shadow-xl sm:text-left uppercase text-[#d1f5ff]">Endurance</h1>
        <h1 id="swim2" class="title-swim text-6xl sm:text-[5rem] font-extrabold drop-shadow-xl sm:text-left uppercase text-[#d1f5ff]">Discipline</h1>
        <h1 id="swim3" class="title-swim text-6xl sm:text-[5rem] font-extrabold drop-shadow-xl sm:text-left uppercase text-[#d1f5ff]">Persévérance</h1>
        <h1 id="swim4" class="title-swim text-6xl sm:text-[5rem] font-extrabold drop-shadow-xl sm:text-left uppercase text-[#d1f5ff]">Détermination</h1>
        <h1 id="swim5" class="title-swim text-6xl sm:text-[5rem] font-extrabold drop-shadow-xl sm:text-left uppercase text-[#d1f5ff]">Passion</h1>
  </template>

<script setup>
import { onMounted, onUnmounted, defineEmits, ref} from 'vue'
import { gsap } from 'gsap'

const emit = defineEmits();

const swimmer = ref(true);

let isScrollListenerAdded = false;
let isAnimationInProgress = false; 
let count = 0;
let delta;

let currentIndex = 0;
let currentOffset = 0;
let currentOffsetSwimmer = 0;

let changeImageOnScroll;
let swimmerAway = false;

let observerSVG;
let observerSwim;

function svgContainerToScreen() {
    window.addEventListener('wheel', changeImageOnScroll);
    const aboutElement = document.getElementById('heroComponent');
    aboutElement.scrollIntoView({
        behavior: 'smooth', 
        block: 'start',
    });
    setTimeout(() => {
        document.body.style.overflow = 'hidden';
    }, 100);
}

function yourFunction() {
    window.removeEventListener('wheel', changeImageOnScroll);
    isScrollListenerAdded = false;


    document.body.style.overflowY = 'auto';
    document.body.style.overflowX = 'hidden';
    swimmer.value = false;
    
    const aboutElement = document.getElementById('aboutComponent');
    
    if (aboutElement) {
        swimmerAway = true;
        aboutElement.scrollIntoView({
            behavior: 'smooth', 
            block: 'start',
        });
        setTimeout(() => {
            document.body.style.overflow = 'auto';
        }, 100); 
    } else {
        console.error("L'élément About n'existe pas.");
    }

    /* *** OBSERVER SVG CONTAINER *** */
    const svgContainer = document.querySelector('.svg-container');
    observerSVG = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    // L'élément est de retour à l'écran
                    console.log('.svg-container est revenu à l\'écran');
                    swimmer.value = true;
                    // Ici, tu peux exécuter une fonction ou une animation, par exemple :
                    svgContainerToScreen();
                }
            });
        }, {
            threshold: 0.1 // L'élément doit être visible à 10% pour être détecté
        });

        setTimeout(() => {
            observerSVG.observe(svgContainer);
        }, 500); 
}

const onTitleVisible = () => {
    console.log("Lance l'animation");
    const allTextElements = document.querySelectorAll(".title-swim");

    allTextElements.forEach((theText) => {
        // Crée les divs pour chaque lettre uniquement une fois
        let lettersHTML = "";
        for (let i = 0; i < theText.innerText.length; i++) {
            lettersHTML += `<div class="letter">${theText.innerText[i] === " " ? "&nbsp;" : theText.innerText[i]}</div>`;
        }
        theText.innerHTML = lettersHTML;

        // Lance l'animation après que les divs soient insérées
        gsap.to(".letter", {
            y: "-50%",
            duration: 0.5,
            ease: "sine.inOut",
            stagger: {
                each: 0.05,
                repeat: -1,
                yoyo: true
            }
        });
    });
};

const swimmerAnim = () => {
    const image = document.getElementById('swimAnimation');
    const imagesForward = ['src/assets/images/nageurAvant.png', 'src/assets/images/nageurArriere.png'];
    const imagesBackward = ['src/assets/images/nageurAvantMiroir.png', 'src/assets/images/nageurArriereMiroir.png'];

    if (isAnimationInProgress) return;

        isAnimationInProgress = true;

        gsap.fromTo(image, {
            opacity: 1,
        }, {
            duration: 0.5,
            opacity: 1,
            onComplete: () => {
                    if(delta > 0)
                        image.src = imagesForward[currentIndex];
                    else
                        image.src = imagesBackward[currentIndex];
                    currentIndex++;
                    count++;
                    currentIndex = currentIndex%2;
                    isAnimationInProgress = false;
            }
        });
}


/*gsap.fromTo(
        "#swimAnimation",
        { opacity: 0 },
        { 
            opacity: 1, 
            duration: 10, 
            ease: "none"
        }
    );*/

onMounted(() => {
    /* *** OBSERVER *** */
    observerSwim = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (!entry.isIntersecting) {
                console.log('swimAnimation est sorti de l’écran');
                yourFunction();
            }
        });
    });

    const swimAnimation = document.getElementById('swimAnimation');
    if (swimAnimation) {
        observerSwim.observe(swimAnimation);
    }
    
    onTitleVisible();
    /* *** ANIMATION LINES *** */
    let i = 0;
    let j = 0;

    // Paramètres de style initial
    gsap.set('.line', { attr: { 'stroke': '#6ec3fe', 'stroke-width': 12, 'stroke-linecap': 'round' } });  // Définir couleur initiale
    gsap.set('.line2', { attr: { 'stroke-width': 18 }, opacity: 0.4 });
    gsap.set('.line3', { attr: { 'stroke-width': 27 }, opacity: 0.15 });

    [].forEach.call(document.getElementsByClassName('line'), (el) => {
        // Utilisation de stroke-dasharray et stroke-dashoffset pour l'animation
        const length = el.getTotalLength();
        gsap.set(el, { strokeDasharray: length, strokeDashoffset: -length });

        gsap.timeline({ defaults: { duration: 10 }, repeat: -1, repeatDelay: (27 - i) / 50 })
        .to(el, { strokeDashoffset: 0, ease: 'sine.in' }, i / 50 - i*0.5)  // Dessine la ligne (de gauche à droite)
        .to(el, { strokeDashoffset: length, ease: 'sine.out' }, 1 + i / 50)  // Efface la ligne (de gauche à droite)
        .progress(1 / 20);

        j++;
        if (j % 3 === 0) {
            i++;
        }
    });

    /* *** ANIMATION SWIMMER *** */
    const swimElement1 = document.getElementById('swim1');
    const initialPosition1 = swimElement1.getBoundingClientRect().left;
    const swimElement5 = document.getElementById('swim1');

    const swimImage = document.getElementById('swimAnimation');
    const initialPositionImage = swimImage.getBoundingClientRect().left;

    changeImageOnScroll = (event) => {
        delta = event.deltaY;
        if(swimElement1.getBoundingClientRect().left > initialPosition1)
        {   
            /* *** SWIMMER TO THE EXTREME LEFT *** */
            if(delta <= 0)
            {
                window.removeEventListener('wheel', changeImageOnScroll);
                if (observerSVG) {
                    console.log("observerSVG is disconnected");
                    observerSVG.disconnect();  // Déconnecte l'observateur pour qu'il ne suive plus l'élément
                }

                if (observerSwim) {
                    console.log("observerSwim is disconnected");
                    observerSwim.disconnect();
                }
                console.log("tout va bien"); 
                /* *** ACTIONS *** */
                console.log("SWIM EVENT");
                gsap.to("#backgroundRipples", {
                    backgroundColor: "#6ec3fe",
                    duration: 0.5,
                    ease: "power1.inOut",
                });

                gsap.to(document.getElementById("waveComponent"), {
                    y: "0%",
                    ease: "power5.out",
                    duration: 1,
                    paused: false,
                });

                emit('swimEvent');
                
                return;
            }
        }
        
        /* *** SWIMMER IS MOVING *** */
        console.log(currentOffset);
        if(currentOffset < -7000 && currentOffsetSwimmer > -1)
        {
            /*console.log("FOOOOOOOOOOOOOOOOOOOOOOOOOOOONCE");
            console.log(initialPositionImage);
            console.log(swimImage.getBoundingClientRect().left);*/
                const moveDistance = window.innerWidth * 0.007; // Déplace de 10% de la largeur de l'écran
                currentOffsetSwimmer += delta > 0 ? +moveDistance : -moveDistance;
                gsap.to("#swimAnimation", {
                    x: currentOffsetSwimmer,
                    duration: 0.5,
                    ease: "none",
                });
                swimmerAnim();
                return;
        }

        if(currentOffsetSwimmer < 0)
                currentOffsetSwimmer = 0;
        /* *** TITLES SWIMMING *** */
        const moveDistance = window.innerWidth * 0.01;
        currentOffset += delta > 0 ? -moveDistance : +moveDistance;

       
            gsap.to(".title-swim", {
                x: currentOffset,
                duration: 0.5,
                ease: "none",
            });
        
        swimmerAnim();
    }
    if (!isScrollListenerAdded) {
        window.addEventListener('wheel', changeImageOnScroll);
        isScrollListenerAdded = true;
    }
});

onUnmounted(() => {
    observerSwim.disconnect();
});
</script>
  
<style scoped>

    section {

    }
  #swimAnimation {
    position: relative;
    top: -30%;
    left: -30%;
  }

  .svg-container {
    position: absolute; /* Positionner par rapport à la fenêtre */
    top: 100%;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    /*border: 5px solid rgb(0, 128, 21);*/
  }

    svg {
    position: absolute;
    }

    .svg1 {
    top: 60%;
    }

    .svg2 {
    top: 40%;
    }

    .svg3 {
    top: -50%;
    /*border: 5px solid rgb(255, 0, 225);*/
    }

    .svg4 {
        /*border: 5px solid rgb(0, 255, 21);*/
    }

    .svg5 {
        top: 37%;
        /*border: 5px solid rgb(255, 157, 0);*/
    }

    .svg6 {
        top: 7%;
        /*border: 5px solid rgb(255, 251, 0);*/
    }

    /* *** WAVY TITLES *** */
    .title-swim {
        position: absolute;
        display: flex; /* Utilisation de flexbox pour afficher les éléments horizontalement */
        flex-direction: row; 
        top: -75%;
    }
    #swim1 {
        top: 110%;
        left: 185%;
        /*border: 5px solid rgb(255, 251, 0);*/
    }
    #swim2 {
        top: 185%;
        left: 250%;
    }
    #swim3 {
        top: 120%;
        left: 312%;
    }
    #swim4 {
        top: 163%;
        left: 389%;
    }
    #swim5 {
        top: 136%;
        left: 428%;
    }
</style>
  